"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _get=function e(t,n,o){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,n);if(void 0===a){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,o)}if("value"in a)return a.value;var r=a.get;if(void 0!==r)return r.call(o)},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(e){var t=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"updateParam",value:function(){return 0}},{key:"connect",value:function(e){return"AudioParamPlus"==e.className?e.delegate=this.updateParam.bind(this):this.node.connect(e),e}},{key:"disconnect",value:function(e){"AudioParamPlus"==e.className?e.delegate=null:this.node.disconnect(e)}},{key:"node",get:function(){return null}}]),e}();e.AudioNodePlus=t}("undefined"!=typeof global?global:window),function(e){var t=Symbol(),n=function(){function e(){_classCallCheck(this,e),this[t]={delegate:null,value:0}}return _createClass(e,[{key:"update",value:function(){var e=this[t];e.delegate&&(e.value=e.delegate())}},{key:"className",get:function(){return"AudioParamPlus"}},{key:"value",get:function(){return this[t].value}},{key:"delegate",set:function(e){this[t].delegate=e},get:function(){return this[t].delegate}}]),e}();e.AudioParamPlus=n}("undefined"!=typeof global?global:window),function(e){var t=Symbol(),n=function(e){function n(e){_classCallCheck(this,n);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this));o[t]={context:e||new AudioContext,destinations:[],velocity:0,gain:null},o.a=0,o.d=0,o.s=1,o.r=0;var a=o[t];return a.gain=a.context.createGain(),a.gain.gain.value=0,o}return _inherits(n,e),_createClass(n,[{key:"on",value:function(e){var n=this[t];n.gain.gain.cancelScheduledValues(0),n.velocity=e;var o=n.context.currentTime,a=o+2*this.a,i=2*this.d+.001,r=n.velocity*this.s;n.gain.gain.setValueAtTime(0,o),n.gain.gain.linearRampToValueAtTime(e,a),n.gain.gain.setTargetAtTime(r,a,i)}},{key:"off",value:function(){var e=this[t];e.gain.gain.cancelScheduledValues(0);var n=e.gain.gain.value,o=e.context.currentTime;e.gain.gain.cancelScheduledValues(o);var a=2*this.r+.001;e.gain.gain.setValueAtTime(n,o),e.gain.gain.setTargetAtTime(0,o,a)}},{key:"node",get:function(){return this[t].gain}}]),n}(AudioNodePlus);e.ADSREnvelopeNode=n}("undefined"!=typeof global?global:window),function(e){var t=Symbol(),n=function(e){function n(e){_classCallCheck(this,n);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this));o[t]={context:e||new AudioContext,node:null,buffer:null,phaseOffset:new AudioParamPlus,offsetBase:0,offset:0,play:!1};var a=o[t];return a.node=a.context.createScriptProcessor(0,0,2),a.node.onaudioprocess=function(e){var n=this[t];if(n.buffer&&n.play){var o=null,a=null;1==n.buffer.numberOfChannels?o=a=n.buffer.getChannelData(0):2==n.buffer.numberOfChannels&&(o=n.buffer.getChannelData(0),a=n.buffer.getChannelData(1));for(var i=e.outputBuffer,r=i.getChannelData(0),l=i.getChannelData(1),s=0;s<i.length;++s)n.offset=n.offsetBase++,n.phaseOffset.update(),n.offset+=n.phaseOffset.value,n.offset%=n.buffer.length,r[s]=o[n.offset],l[s]=a[n.offset];n.offsetBase%=n.buffer.length}}.bind(o),o}return _inherits(n,e),_createClass(n,[{key:"start",value:function(){var e=this[t];e.offsetBase=0,e.play=!0}},{key:"stop",value:function(){var e=this[t];e.play=!1}},{key:"node",get:function(){return this[t].node}},{key:"buffer",set:function(e){this[t].buffer=e},get:function(){return this[t].buffer}},{key:"phaseOffset",get:function(){return this[t].phaseOffset}},{key:"offset",get:function(){return this[t].offset}}]),n}(AudioNodePlus);e.AudioBufferPlaybackNode=n}("undefined"!=typeof global?global:window),function(e){var t=Symbol(),n=function(e){function n(e){_classCallCheck(this,n);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this));return o[t]={gain:e,loopData:[],loopDataIndex:0,nextEvent:0,offset:0,time:0,delta:0,callback:null},o}return _inherits(n,e),_createClass(n,[{key:"updateParam",value:function(){var e=this[t];return e.time++,e.time>=e.nextEvent?(e.offset=e.loopData[e.loopDataIndex++].offset,e.nextEvent=e.loopData[e.loopDataIndex].time,e.delta=e.loopData[e.loopDataIndex].delta):e.offset+=e.delta,e.time>=e.gain&&(e.loopDataIndex=0,e.nextEvent=e.loopData[0].time,e.offset=0,e.time=0,e.callback&&e.callback()),0|e.offset}},{key:"data",set:function(e){var n=this[t];n.loopData=[];var o=0,a=0,i=!0,r=!1,l=void 0;try{for(var s,u=e[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var c=s.value,f=0;"line"==c.mode&&(f=(c.offset*n.gain-a)/(c.time*n.gain-o)),o=c.time*n.gain,a=c.offset*n.gain,console.log(o,a,f),n.loopData.push({time:o,offset:a,delta:f}),console.log(n.loopData[n.loopData.length-1])}}catch(e){r=!0,l=e}finally{try{!i&&u.return&&u.return()}finally{if(r)throw l}}n.loopData.push({time:n.gain+1,offset:0,delta:0}),n.loopDataIndex=0,n.nextEvent=n.loopData[0].time,n.offset=0,n.index=0}},{key:"onloop",set:function(e){this[t].callback=e}}]),n}(AudioNodePlus);e.LoopMakerNode=n}("undefined"!=typeof global?global:window),function(e){var t=Symbol(),n=function(e){function n(e){_classCallCheck(this,n);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this));return o[t]={context:e||new AudioContext,state:"closed",stateChangeListeners:[],controlChangeListeners:[],changeState:function(e){if(o[t].state!=e){o[t].state=e;var n=new Event("statechange");n.port=o,o.dispatchEvent(n)}}},o.onstatechange=null,o.oncontrolchange=null,o}return _inherits(n,e),_createClass(n,[{key:"addEventListener",value:function(e,n,o){"statechange"==e?this[t].stateChangeListeners.push(n):"controlchange"==e&&this[t].controlChangeListeners.push(n)}},{key:"removeEventListener",value:function(e,n,o){if("statechange"==e){var a=this[t].stateChangeListeners.indexOf(n);a>=0&&this[t].stateChangeListeners.splice(a)}else if("controlchange"==e){var i=this[t].controlChangeListeners.indexOf(n);i>=0&&this[t].controlChangeListeners.splice(i)}}},{key:"dispatchEvent",value:function(e){return"statechange"==e.type?(this[t].stateChangeListeners.forEach(function(t){t(e)}),this.onstatechange&&this.onstatechange(e)):"controlchange"==e.type&&(e.target||(e.port=this),this[t].controlChangeListeners.forEach(function(t){t(e)}),this.oncontrolchange&&this.oncontrolchange(e)),e.defaultPrevented||!0}},{key:"open",value:function(){var e=this;return new Promise(function(n,o){e[t].changeState("open"),n(e)})}},{key:"close",value:function(){var e=this;return new Promise(function(n,o){e[t].changeState("closed"),n(e)})}},{key:"send",value:function(e){this[t].changeState("open")}},{key:"clear",value:function(){}},{key:"programs",get:function(){return[]}},{key:"controls",get:function(){return[]}},{key:"id",get:function(){return btoa(this.name())}},{key:"manufacturer",get:function(){return"toyoshim@gmail.com"}},{key:"name",get:function(){return"MIDIOutputAudioNode"}},{key:"type",get:function(){return"output"}},{key:"version",get:function(){return"0.91"}},{key:"state",get:function(){return this[t].state}},{key:"connection",get:function(){return"connected"}}]),n}(AudioNodePlus);e.MIDIOutputAudioNode=n}("undefined"!=typeof global?global:window),function(e){var t=Symbol(),n=function(e){function n(e){_classCallCheck(this,n);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return o[t]={sendErrorHeader:"Failed to execute 'send' on '"+o.constructor.name+"': ",dataCheck:function(e,n,a){var i=n;if(n<128){if(void 0===a||a<128)return;e++,i=a}throw TypeError(o[t].sendErrorHeader+"Unexpected status byte at index "+e+" ("+i+").")}},o}return _inherits(n,e),_createClass(n,[{key:"send",value:function(e){_get(Object.getPrototypeOf(n.prototype),"send",this).call(this,e);for(var o=this[t],a=0;a<e.length;++a){var i=e[a]>>4,r=15&e[a];if(i<8)throw new TypeError(o.sendErrorHeader+"Running status is not allowed at index "+a+" ("+e[a]+").");switch(i){case 8:if(a+2>=e.length)break;o.dataCheck(a+1,e[a+1],e[a+2]),this.handleNoteOff(r,e[a+1],e[a+2]),a+=2;continue;case 9:if(a+2>=e.length)break;o.dataCheck(a+1,e[a+1],e[a+2]),0===e[a+2]?this.handleNoteOff(r,e[a+1],e[a+2]):this.handleNoteOn(r,e[a+1],e[a+2]),a+=2;continue;case 10:if(a+2>=e.length)break;o.dataCheck(a+1,e[a+1],e[a+2]),this.handleKeyPressure(r,e[a+1],e[a+2]),a+=2;continue;case 11:if(a+2>=e.length)break;o.dataCheck(a+1,e[a+1],e[a+2]),this.handleControlChange(r,e[a+1],e[a+2]),a+=2;continue;case 12:if(a+1>=e.length)break;o.dataCheck(a+1,e[a+1]),this.handleProgramChange(r,e[a+1]),a+=1;continue;case 13:if(a+1>=e.length)break;o.dataCheck(a+1,e[a+1]),this.handleChannelPressure(r,e[a+1]),a+=1;continue;case 14:if(a+2>=e.length)break;o.dataCheck(a+1,e[a+1],e[a+2]),this.handlePitchBendChange(r,(e[a+2]<<7)+e[a+1]-8192),a+=2;continue}switch(e[a]){case 240:for(var l=1;l<=e.length-a;++l){if(247==e[a+l]){this.handleSystemExclusive(e.slice(a+1,a+l)),a+=l;break}if(e[a+l]>=128)throw new TypeError(o.sendErrorHeader+"System exclusive message contains a status byte at index "+(a+l)+" ("+e[a+l]+").")}if(247==e[a])continue;throw new TypeError(o.sendErrorHeader+"System exclusive message is not ended by end of system exclusive message.");case 241:this.handleTimeCodeQuarterFrame();continue;case 242:if(a+1>=e.length)break;o.dataCheck(a+1,e[a+1]),this.handleSongPositionPointer(e[a+1]),a+=1;continue;case 243:if(a+1>=e.length)break;o.dataCheck(a+1,e[a+1]),this.handleSongSelect(e[a+1]),a+=1;continue;case 246:this.handleTuneRequest();continue;case 247:throw new TypeError(o.sendErrorHeader+"Unexpected end of system exclusive message at index "+a+" ("+e[a]+").");case 248:this.handleTimingClock();continue;case 250:this.handleStart();continue;case 251:this.handleContinue();continue;case 252:this.handleStop();continue;case 254:this.handleActiveSensing();continue;case 255:this.handleReset();continue;case 244:case 245:case 249:case 253:throw new TypeError(o.sendErrorHeader+"Reserved status is not allowed at index "+a+" ("+e[a]+").")}throw new TypeError(o.sendErrorHeader+"Message is incomplete.")}}},{key:"getFrequencyForNote",value:function(e,t){return 440*Math.pow(2,(e-69+t/2048)/12)}},{key:"handleNoteOff",value:function(e,t,n){}},{key:"handleNoteOn",value:function(e,t,n){}},{key:"handleKeyPressure",value:function(e,t,n){}},{key:"handleControlChange",value:function(e,t,n){}},{key:"handleProgramChange",value:function(e,t){}},{key:"handleChannelPressure",value:function(e,t){}},{key:"handlePitchBendChange",value:function(e,t){}},{key:"handleSystemExclusive",value:function(e){}},{key:"handleTimeCodeQuarterFrame",value:function(){}},{key:"handleSongPositionPointer",value:function(e){}},{key:"handleSongSelect",value:function(e){}},{key:"handleTuneRequest",value:function(){}},{key:"handleTimingClock",value:function(){}},{key:"handleStart",value:function(){}},{key:"handleContinue",value:function(){}},{key:"handleStop",value:function(){}},{key:"handleActiveSensing",value:function(){}},{key:"handleReset",value:function(){}},{key:"name",get:function(){return"MIDIOutputAudioNodeHelper"}},{key:"version",get:function(){return"0.91"}}]),n}(MIDIOutputAudioNode);e.MIDIOutputAudioNodeHelper=n}("undefined"!=typeof global?global:window),AudioContext.prototype.loadAudioData=function(e){var t=this;return new Promise(function(n,o){var a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=function(){if(a.readyState==a.DONE)return 200!==a.status?o(a):void t.decodeAudioData(a.response).then(function(e){n(e)},function(e){o(e)})},a.open("GET",e,!0),a.send()})},AudioContext.prototype.createBufferPlayback=function(){return new AudioBufferPlaybackNode(this)},AudioContext.prototype.createLoopMaker=function(e){return new LoopMakerNode(e)},function(e){var t=Symbol(),n=function(){function e(t,n,o){_classCallCheck(this,e),this.noteOn=t,this.noteChange=n,this.noteOff=o,this.notes=[],this.velocities={}}return _createClass(e,[{key:"handleNoteOff",value:function(e,t){var n=this.notes.indexOf(e);if(n>=0&&(this.notes.splice(n,1),delete this.velocities[e]),0===this.notes.length)this.noteOff();else{var o=this.notes[this.notes.length-1];this.noteChange(o,this.velocities[o])}}},{key:"handleNoteOn",value:function(e,t){this.notes.push(e),this.velocities[e]=t,this.noteOn(e,t)}}]),e}(),o=function(e){function o(e){_classCallCheck(this,o);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(o).call(this,e));a[t]={context:e||new AudioContext,oscillator:null,envelope:null,lfo:null,lfoGain:null,types:["sine","square","sawtooth","triangle"],note:69,bend:0,noteController:null};var i=a[t];i.oscillator=i.context.createOscillator(),i.oscillator.type="sine",i.oscillator.frequency.value=440,i.oscillator.start(),i.envelope=new ADSREnvelopeNode(i.context),i.lfo=i.context.createOscillator(),i.lfo.type="sine",i.lfo.frequency.value=6,i.lfo.start(),i.lfoGain=i.context.createGain(),i.lfoGain.gain.value=0,i.oscillator.connect(i.envelope.node),i.lfo.connect(i.lfoGain),i.lfoGain.connect(i.oscillator.detune);var r=function(e,t){i.note=e,i.oscillator.frequency.setValueAtTime(a.getFrequencyForNote(i.note,i.bend),0),i.envelope.on(t/127)},l=function(e,t){i.envelope.off()};return i.noteController=new n(r,r,l),a}return _inherits(o,e),_createClass(o,[{key:"handleNoteOff",value:function(e,n,o){0==e&&this[t].noteController.handleNoteOff(n,o)}},{key:"handleNoteOn",value:function(e,n,o){0==e&&this[t].noteController.handleNoteOn(n,o)}},{key:"handleKeyPressure",value:function(e,t,n){}},{key:"handleControlChange",value:function(e,n,o){if(0==e){var a=this[t],i=void 0;switch(n){case 1:return void(a.lfoGain.gain.value=o);case 73:a.envelope.a=o/127,i="A";break;case 72:a.envelope.d=o/127,i="D";break;case 74:a.envelope.s=o/127,i="S";break;case 71:a.envelope.r=o/127,i="R"}var r=new Event("controlchange");r.control={name:i,value:o},this.dispatchEvent(r)}}},{key:"handleProgramChange",value:function(e,n){if(0==e){var o=this[t];n>o.types.length||(o.oscillator.type=o.types[n],o.envelope.a=this.controls[0].default/127,o.envelope.d=this.controls[1].default/127,o.envelope.s=this.controls[2].default/127,o.envelope.r=this.controls[3].default/127)}}},{key:"handleChannelPressure",value:function(e,t){}},{key:"handlePitchBendChange",value:function(e,n){if(0==e){var o=this[t];o.bend=3*n,o.oscillator.frequency.setValueAtTime(this.getFrequencyForNote(o.note,o.bend),0)}}},{key:"handleSystemExclusive",value:function(e){}},{key:"handleReset",value:function(){}},{key:"node",get:function(){return this[t].envelope}},{key:"manufacturer",get:function(){return"toyoshim@gmail.com"}},{key:"name",get:function(){return"MIDIOutputOscillatorNode"}},{key:"version",get:function(){return"1.00"}},{key:"programs",get:function(){return[{name:"Sine",controls:[]},{name:"Square",controls:[]},{name:"Sawtooth",controls:[]},{name:"Triangle",controls:[]}]}},{key:"controls",get:function(){var e=this[t].envelope;return[{name:"A",value:127*e.a,min:0,max:127,default:0,cc:[73]},{name:"D",value:127*e.d,min:0,max:127,default:0,cc:[72]},{name:"S",value:127*e.s,min:0,max:127,default:127,cc:[74]},{name:"R",value:127*e.r,min:0,max:127,default:0,cc:[71]}]}}]),o}(MIDIOutputAudioNodeHelper);e.MIDIOutputOscillatorNode=o}("undefined"!=typeof global?global:window);